tasks:
    images:
        build:
            services:
                web:
                    steps:
                        - docker_file_path: ./docker/build/Buildfile
                          build_directory: ./ui
                          write_artifacts:
                              - name: user-interface
                                path: /app/dist
                        - docker_file_path: ./Dockerfile
                          read_artifacts:
                              - name: user-interface
                                path: /static
                          image: docker.io/continuouspipe/kube-status

    deployment:
        filter:
            expression: code_reference.branch == "master" or "cp:tide" in pull_request.labels
        
        deploy:
            cluster: ${CLUSTER}
            environment:
                name: '"kube-status-" ~ code_reference.branch'
            services:
                web:
                    endpoints:
                        -
                            name: https
                            type: NodePort
                            ssl_certificates:
                                -
                                    name: continuouspipeio
                                    cert: ${WILDCARD_SSL_CERT}
                                    key: ${WILDCARD_SSL_KEY}

                    specification:
                        command:
                        - /app/run.sh
                        - -cluster-provider=within-k8s
                        ports:
                          - 80
                        environment_variables:
                            - name: KUBE_STATUS_LISTEN_ADDRESS
                              value: ${KUBE_STATUS_LISTEN_ADDRESS}

                    deployment_strategy:
                        readiness_probe:
                            type: tcp
                            port: 80
