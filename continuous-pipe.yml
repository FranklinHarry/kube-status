tasks:
    images:
        build:
            services:
                web:
                    image: docker.io/continuouspipe/kube-status
                    naming_strategy: sha1

    deployment:
        filter:
            expression: code_reference.branch == "master"
        
        deploy:
            cluster: ${CLUSTER}
            environment:
                name: '"kube-status-" ~ code_reference.branch'
            services:
                web:
                    endpoints:
                        -
                            name: https
                            type: NodePort
                            ssl_certificates:
                                -
                                    name: continuouspipeio
                                    cert: ${WILDCARD_SSL_CERT}
                                    key: ${WILDCARD_SSL_KEY}

                    specification:
                        ports:
                          - 80
                        environment_variables:
                            - name: KUBE_STATUS_LISTEN_ADDRESS
                              value: ${KUBE_STATUS_LISTEN_ADDRESS}

                    deployment_strategy:
                        readiness_probe:
                            type: tcp
                            port: 80
